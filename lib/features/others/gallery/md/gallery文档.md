# gallery

## Golang 扫描/搬运器（离线批处理）

后端程序 gallery：工作节点 (CLI Tool)
逻辑：负责物理文件的摄入与生命周期管理。

Ingestion Pipeline (摄入流水线 - 选项1):

- 深度遍历路径1(rawDir)，获取所有图片/视频(.jpg, .webp, .jpeg, .png, .mp4, .gif等等所有可以称之为图片和视频的文件)进行如下操作:

  - 计算该文件的sha-256哈希值, 如果数据库中有该记录则将该文件移动到路径3(deletedDir).并跳过后续步骤进入下一个文件的操作.
  - 抽取媒体元信息（尺寸、时长、文件日期(优先级: EXIF > 修改时间 > 创建时间)、文件哈希、感知哈希等）
  - 计算“文件日期”规则(选取文件的'创建时间'和'修改时间'中更早的那个)
  - 按 yyyy-mm 归档移动(move)到路径2（mediaDir）, (即mediaDir表示的目录下有若干'yyyy-mm'形式的文件夹, 如果没有则创建)，记录状态等.
  - 缩略图生成. (如果是视频则选取时间上第10%的那一帧的图片,后续与一般图片相同处理. 另外.gif之类的文件的压缩仍旧是'内容完整'的, 仅对分辨率压缩.)
    - 1. 256*256的网格展示缩略图.
      -  非方形原图则尽量选取中心部位, 且等比缩放至生成图不留白(即可截取但不可留白).
    - 2. 按原图比例等比缩放到最大边为512px的预览图.

  - 逻辑上各缩略图是"从属"于原图的. 后续执行'删除'操作时将原图和缩略图以及预览图同步移动到deletedDir.
  - 将原文件移动至 Media/YYYY-MM/filename.ext。将缩略图移动至 thumbs/YYYY-MM/filename_thumb.ext。将预览图移动至 previews/YYYY-MM/filename_thumb.ext.

- 将各数据写入 Postgres.

Execution Pipeline (执行流水线 - 选项2):

- Delete Handling: 查询 is_deleted=true 的记录。将物理文件移动到 deleted/ 目录 (作为安全网，不立即物理删除) 包括所有group_id为该文件id的及相关文件的缩略图和预览图。
- Cleanup: 清理空文件夹。

### 说明
- 做好错误处理与一般的兜底以及打印输出提示信息.
- 遍历文件/写入数据库的批量优化, 引入并发控制.
- 视频处理使用ffmpeg, (相关依赖已加入环境变量).
